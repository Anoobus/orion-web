@using orion.web.Employees
@using orion.web.TimeEntries

@model orion.web.TimeEntries.FullTimeEntryViewModel

<nav id="bread-crumb-bar" class="red darken-3">
    <div class="nav-wrapper ">
        <div class="col s12">
            <a href="#!" class="breadcrumb">Home</a>
            <a href="@Url.Action("IndexForEmployee","TimeEntry",new { employeeId = Model.EmployeeId })" class="breadcrumb"> @Model.EmployeeDisplayName's Weekly Listing</a>
            <a href="#!" class="breadcrumb">Time Entry For Week Starting: @Model.Week.WeekStart.ToShortDateString()</a>
            <input type="hidden" id="current-week-id" asp-for="Week.WeekId" />
            <input type="hidden" id="current-employee-id" asp-for="EmployeeId" />
        </div>
    </div>
</nav>

<div class="megawrap">
    <div class="row ">
        <div class="col s3">
            <a href="@Url.Action(nameof(TimeEntryController.Edit),"TimeEntry",new { employeeId = Model.EmployeeId, weekId = Model.Week.WeekId - 1 })" class="btn grey darken-2">
                Previous Week
            </a>
        </div>
        <div class="col s3">
            <span>
                <label asp-for="Week.WeekStart" class="control-label"></label> @Model.Week.WeekStart.ToShortDateString()
            </span>
        </div>
        <div class="col s3">
            <span>

                <label asp-for="Week.WeekEnd" class="control-label"></label> @Model.Week.WeekEnd.ToShortDateString()
            </span>

        </div>
        <div class="col s3 last-nav-item">
            <a href="@Url.Action(nameof(TimeEntryController.Edit),"TimeEntry",new { employeeId = Model.EmployeeId, weekId = Model.Week.WeekId + 1 })" class="btn grey darken-2"> Next Week </a>
        </div>
    </div>
</div>

<style>
    div.form-group.skinny input[type=text] {
        font-size: 12px;
        margin-bottom: 0px;
    }

    div.last-nav-item {
        text-align: right;
    }

        div.last-nav-item a {
            margin-right: 16px;
        }

    div.megawrap {
        width: 1540px;
        margin-left: auto;
        margin-right: auto;
    }

    #time-entry {
        width: 1540px;
    }

        #time-entry td,
        #time-entry td input[type='text'],
        #time-entry th {
            text-align: center;
        }

            #time-entry th.job-task-description {
                min-width: 50%;
            }

            #time-entry td.description-cell {
                text-align: left;
                margin-top: 2px;
                margin-bottom: 2px;
                padding-top: 6px;
                padding-bottom: 6px;
                overflow-y: hidden;
            }

        #time-entry td {
            line-height: 12px;
            font-size: 9px;
            padding-top: 0px;
            padding-bottom: 0px;
        }

            #time-entry td.description-cell {
                line-height: 15px;
            }

            #time-entry td label {
                color: #000000;
            }



        #time-entry tbody tr td.description-cell {
            font-size: 15px;
            font-weight: bold;
        }

        #time-entry tbody tr:hover {
            border-style: none;
        }

        #time-entry thead tr,
        #time-entry tfoot tr,
        #time-entry td.readonly-header-cell,
        #time-entry th.readonly-header-cell {
            background: #37474f;
            color: #FFF;
            font-size: 12px;
            text-align: center;
        }

    th.week-header-cell.ot-cell,
    th.week-header-cell.header-ot-total {
        width: 54px;
        padding: 5px 0px 5px 0px;
    }

    div.week-errors {
        padding: 6px;
        margin: 8px;
        background-color: #c62828;
        color: #FFF;
        font-weight: bold;
        padding-top: 2px;
        padding-bottom: 2px;
        font-size: .7rem;
    }



    table tfoot tr th, table thead tr th {
        padding-top: 5px;
        padding-bottom: 5px;
        padding-left: 0px;
        padding-right: 0px;
    }

    td.description-cell div.row {
        margin-top: 0px;
        margin-bottom: 0px;
        padding-top: 1px;
        padding-bottom: 1px;
    }

    div.effort-area {
        font-size: 16px;
        padding-left: 0px;
        padding-right: 0px;
        margin-left: 0px;
        margin-right: 1px;
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
        font-stretch: condensed;
        font-style: normal;
    }

    div.description.effort-area.jobname {
        overflow-wrap: break-word;
        -webkit-hyphens: auto;
        -ms-hyphens: auto;
        hyphens: auto;
        color: rgb(97, 97, 97);
        display: inline;
    }

    div.description.effort-area.jobcode {
        overflow-wrap: break-word;
        -webkit-hyphens: auto;
        -ms-hyphens: auto;
        hyphens: auto;
        display: inline;
    }

    div.effort-area.taskline {
        font-size: 14.5px overflow-wrap: break-word;
        -webkit-hyphens: auto;
        -ms-hyphens: auto;
        hyphens: auto;
        display: block
    }

    td.description-cell div.row.taskline-row {
        margin-top: -2px;
    }

    th.week-header-cell {
        min-width: 24px;
    }

    div.select-wrapper ul.dropdown-content.select-dropdown li {
        line-height: 10px;
        font-size: 12px;
        min-height: 10px;
    }

        div.select-wrapper ul.dropdown-content.select-dropdown li > span {
            min-height: 10px;
        }

    div.task-name {
        font-size: .85rem;
    }

        div.task-name a {
            line-height: 11px;
        }

    .job-task-ops-dropdown, .job-task-ops-dropdown.drop-down-content {
        width: 175px;
        min-width: 175px;
    }

        .job-task-ops-dropdown.drop-down-content li a {
            padding: 2px;
            margin: 0px;
        }

        .job-task-ops-dropdown li a.action-change-row, .job-task-ops-dropdown li a.action-remove-row {
            font-size: .75rem;
            padding: 5px;
            margin: 0px;
        }


    a.option-btn.btn-floating.btn-small i {
        margin: 0px;
        font-size: 0.75rem;
        line-height: 13px;
    }

    a.option-btn.btn-floating.btn-small {
        float: left;
        height: 13px;
        width: 13px;
        font-size: 8px;
        margin-top: 2px;
        line-height: 11px;
        opacity: 60%;
        margin-right: 3px;
    }

    .validation-summary-valid {
        display: none;
        font-size: 1.5em;
    }

    .tighter {
        padding-left: 8%;
        padding-right: 8%;
    }

    .hide-the-text {
        color: rgba(0,0,0,0);
    }
</style>

<form asp-action="Save" method="post" id="main-time-entry-form">

    <div class="megawrap">
        <div class="row time-entry-horz">
            <div class="col s12">
                <div asp-validation-summary="All" class="col s10 offset-s1 text-danger card-panel week-errors pulse rounded"></div><div class="col s1"></div>
                <script type="text/javascript">document.addEventListener('DOMContentLoaded', function () {
                        let errors = document.querySelectorAll('div.week-errors ul li');
                        if (errors.length) {
                            console.log(errors[0].innerHTML);
                            let iconRow = document.createElement("li");
                            iconRow.innerHTML = '<i class="tiny material-icons">error_outline</i>';
                            console.log("to add", iconRow);
                            errors[0].parentElement.prepend(iconRow);
                            errors.forEach(li => li.innerHTML = '&nbsp;&nbsp;' + li.innerHTML);
                        }
                        setTimeout(() => {
                            console.log('remove pulse');
                            document.getElementsByClassName("week-errors")[0].classList.remove('pulse');
                            console.log('pulse removed');
                        }, 3500);
                    })</script>
            </div>
        </div>
    </div>
    <div class="megawrap">
        <div class="row time-entry-horz">
            <div class="col s12">


                @if (Model.ApprovalStatus == orion.web.TimeEntries.TimeApprovalStatus.Approved
|| Model.ApprovalStatus == orion.web.TimeEntries.TimeApprovalStatus.Submitted)
                {
                    <div class="row">
                        <div class="col s8 offset-s2">
                            <h5>
                                <strong>Please Note:</strong> No more changes are allowed for timesheet becuase it is already @Model.ApprovalStatus.
                            </h5>
                        </div>
                    </div>
                }

                <table class="table highlight z-depth-4 striped" id="time-entry">
                    <thead>
                        <tr class="z-depth-2">
                            <th class="job-task-description " colspan="2">Effort</th>
                            <th day="col-saturday" class="week-header-cell">
                                Sat
                                <a href="#" class="ot-button white-text">
                                    <i class="tiny material-icons">access_time</i>
                                </a>
                            </th>
                            <th style="display:none" day="ot-col-saturday" class="week-header-cell ot-cell">Sat<sup>ot</sup></th>
                            <th day="col-sunday" class="week-header-cell">
                                Sun
                                <a href="#" class="ot-button white-text">
                                    <i class="tiny material-icons">access_time</i>
                                </a>
                            </th>
                            <th style="display:none" day="ot-col-sunday" class="week-header-cell ot-cell">Sun<sup>ot</sup></th>
                            <th day="col-monday" class="week-header-cell">
                                Mon
                                <a href="#" class="ot-button white-text">
                                    <i class="tiny material-icons">access_time</i>
                                </a>
                            </th>
                            <th style="display:none" day="ot-col-monday" class="week-header-cell ot-cell">Mon<sup>ot</sup></th>
                            <th day="col-tuesday" class="week-header-cell">
                                Tues
                                <a href="#" class="ot-button white-text">
                                    <i class="tiny material-icons">access_time</i>
                                </a>
                            </th>
                            <th style="display:none" day="ot-col-tuesday" class="week-header-cell ot-cell">Tue<sup>ot</sup></th>
                            <th day="col-wednesday" class="week-header-cell">
                                Wed
                                <a href="#" class="ot-button white-text">
                                    <i class="tiny material-icons">access_time</i>
                                </a>
                            </th>
                            <th style="display:none" day="ot-col-wednesday" class="week-header-cell ot-cell">Wed<sup>ot</sup></th>
                            <th day="col-thursday" class="week-header-cell">
                                Thur
                                <a href="#" class="ot-button white-text">
                                    <i class="tiny material-icons">access_time</i>
                                </a>
                            </th>
                            <th style="display:none" day="ot-col-thursday" class="week-header-cell ot-cell">Thur<sup>ot</sup></th>
                            <th day="col-friday" class="week-header-cell">
                                Fri
                                <a href="#" class="ot-button white-text">
                                    <i class="tiny material-icons">access_time</i>
                                </a>
                            </th>
                            <th style="display:none" day="ot-col-friday" class="week-header-cell ot-cell">Fri<sup>ot</sup></th>
                            <th style="display:none" day="ot-col-total" class="week-header-cell header-ot-total">Total<sup>ot</sup></th>
                            <th day class="week-header-cell header-total"></th>
                        </tr>
                    </thead>
                    <tbody>
                        @{
                            int i = 0;
                            foreach (var thing in Model.TimeEntryRow)
                            {
                                @Html.EditorFor(m => thing, "~/UI/Views/TimeEntry/TimeEntryRow.cshtml", "TimeEntryRow[" + i++ + "]")
                            }
                        }
                    </tbody>
                    <tfoot>
                        <tr>
                            <th colspan="2">
                                <button type="button"
                                        id="AddJob" class="btn grey darken-2">
                                    Add Job/Task
                                </button>
                            </th>
                            <th day="col-saturday"></th>
                            <th day="ot-col-saturday" style="display:none"></th>

                            <th day="col-sunday"></th>
                            <th day="ot-col-sunday" style="display:none"></th>

                            <th day="col-monday"></th>
                            <th day="ot-col-monday" style="display:none"></th>

                            <th day="col-tuesday"></th>
                            <th day="ot-col-tuesday" style="display:none"></th>

                            <th day="col-wednesday"></th>
                            <th day="ot-col-wednesday" style="display:none"></th>

                            <th day="col-thursday"></th>
                            <th day="ot-col-thursday" style="display:none"></th>

                            <th day="col-friday"></th>
                            <th day="ot-col-friday" style="display:none"></th>

                            <th day="ot-col-total" class="readonly-header-cell hide-on-small-only" style="display:none"></th>
                            <th day="col-total" class="readonly-header-cell hide-on-small-only"></th>
                        </tr>
                    </tfoot>
                </table>

            </div>
        </div>
    </div>
    <div class="megawrap">
        <div class="row time-entry-horz">
            <div class="col s12">

                @if (Model.ApprovalStatus == orion.web.TimeEntries.TimeApprovalStatus.Unkown
|| Model.ApprovalStatus == orion.web.TimeEntries.TimeApprovalStatus.Rejected)
                {



                    <button type="button" class="waves-effect waves-white btn grey darken-2" id="copy-prev-week-tasks-trigger">Copy Job/Tasks From Previous Week</button>

                    <input id="save-btn" type="submit" name="postType" value="Save" class="btn grey darken-2" />
                    <button type="button" class="waves-effect waves-white btn" id="submit-modal-trigger">Submit</button>

                }

                @if (User.IsInRole(UserRoleName.Admin))
                {
                    @if (Model.ApprovalStatus == orion.web.TimeEntries.TimeApprovalStatus.Submitted)
                    {
                        <input type="submit" name="postType" class="btn" value="Approve" id="btnApprove" />
                    }

                    @if (Model.ApprovalStatus == orion.web.TimeEntries.TimeApprovalStatus.Submitted
|| Model.ApprovalStatus == orion.web.TimeEntries.TimeApprovalStatus.Approved)
                    {
                        <input type="submit" name="postType" class="btn " value="Reject" id="btnReject" />
                    }
                }

            </div>
        </div>
    </div>
    <div class="modal modal-small" id="copyModal">
        <div class="row">
            <div class="col s3 red darken-3 white-text modal-info-blurb z-depth-4">
                <div class="container">
                    <h5>
                        Copy Prevous Week Entries
                    </h5>
                </div>
            </div>
            <div class="col s9">
                <div class="row" style="padding:20px">
                    <p>
                        Would you like to include rows that have no time applied?<br />
                        By default only job/task(s) which have hours applied, will be copied to this week.
                    </p>
                    <br />
                    <br />
                    <label>
                        <input asp-for="IncludeRowsWithNoEffortAppliedOnCopyPreviousWeekTasks" type="checkbox" />
                        <span>Also include entries with <em>NO</em> hours applied</span>
                    </label>
                </div>

                <div class="modal-footer" style="vertical-align:bottom;margin-top:30px">
                    <input type="submit" name="postType" value="Copy Job/Tasks From Previous Week" class="waves-effect waves-white btn-flat" />
                    <button type="button" class="modal-close waves-effect waves-white btn-flat" data-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal modal-small" id="submitModal">
        <div class="row">
            <div class="col s3 red darken-3 white-text modal-info-blurb z-depth-4">
                <div class="container">

                </div>
            </div>
            <div class="col s9">
                <div class="row" style="padding:20px">

                    <h4>
                        Are you sure you want to submit your time?
                    </h4>

                </div>

                <div class="modal-footer" style="vertical-align:bottom;margin-top:30px">
                    <button type="submit" name="postType" value="Submit" class="waves-effect waves-white btn-flat">Submit Time</button>
                    <button type="button" class="modal-close waves-effect waves-white btn-flat" data-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <style>
        .modal {
            overflow: hidden;
            min-height: 500px !important;
        }

        .modal-small {
            overflow: hidden;
            max-height: 50%;
            width: 40%;
            min-height: 280px !important;
        }

        .modal-info-blurb {
            height: 100vh;
        }

        .ot-cell-gradient {
            background: rgba(252, 248, 22, 0.25)
        }

        div.modal-easment {
            margin: 5px 10px;
            padding: 5px 10px;
        }
    </style>

    <div id="add-row-modal" class="modal">

        <div class="row">
            <div class="col s3 red darken-3 white-text modal-info-blurb z-depth-4">
                <div class="container">
                    <h5>Add Job To Time Sheet</h5>
                    <h6>Don't see your job? Click below to manage your job list.</h6>
                    <a class="btn grey darken-2" asp-controller="Jobs" asp-action="List" delay-for-save="yup">Manage</a>
                </div>
            </div>
            <div class="col s9">
                <div class="modal-easment">
                    <div class="row">
                        @if (Model.NewEntry.AvailableJobs.Any())
                        {
                            <div class="row" style="display:none" id="notification-block">
                                <div class="col s12">
                                    <div id="notification-block-content" class="text-danger card-panel week-errors pulse rounded"></div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col s12">

                                   Job Selection Type: 
                                    <label for="auto-job">

                                        <input type="radio" class="with-gap" value="auto" id="auto-job" />
                                        <span>Quick Search</span>

                                    </label>
                                    <label for="dd-job">
                                        <input type="radio" class="with-gap" value="dd" id="dd-job" checked="checked"  />
                                       <span>Drop Down</span>
                                    </label>

                                  
                                </div>
                            </div>
                            <div class="row">
                                <div class="col s12">
                                    <div class="input-field">
                                        <div id="job-by-quick-search" style="display:none">
                                            <i class="material-icons prefix">search</i>
                                            <input type="text" id="AddJobTaskAutoComplete"
                                                   class="autocomplete validate"
                                                   onfocus="oneTimeClear(this)"
                                                   placeholder="Type Job Code..." />
                                            <label for="NewlySelectedJob-Name">Job To Add</label>
                                        </div>
                                        <div id="job-dd">
                                            <label asp-for="NewEntry.SelectedJobId">Job To Add</label>
                                            <select asp-for="NewEntry.SelectedJobId" class="custom-drop-down job"
                                                    asp-items="@(new SelectList(Model.NewEntry.AvailableJobs, "JobId", "FullJobCodeWithName"))">
                                            </select>
                                        </div>
                                    </div>

                                </div>
                            </div>
                            <div class="row">
                                <div class="col s6">
                                    <label asp-for="NewEntry.SelectedTaskCategory">Task Category</label>
                                    <select asp-for="NewEntry.SelectedTaskCategory"
                                            disabled
                                            class="custom-drop-down category">

                                        @foreach (var cat in Model.NewEntry.AvailableCategories)
                                        {
                                            <option value="@cat.Name" internal-only="@cat.IsInternalCategory.ToString().ToLower()">@cat.Name</option>
                                        }
                                    </select>
                                </div>
                                <div class="col s6">
                                    <label asp-for="NewEntry.SelectedTaskId">Task</label>
                                    <select asp-for="NewEntry.SelectedTaskId" disabled class="custom-drop-down task">

                                        @foreach (var task in Model.NewEntry.AvailableTasks)
                                        {
                                            <option value="@task.TaskId" class="@task.Category.Name">@task.LegacyCode - @task.Name</option>
                                        }
                                    </select>
                                </div>
                            </div>
                        }

                    </div>
                </div>
                <div class="modal-easment">
                    <div class="modal-footer" style="vertical-align:bottom">
                        <button id="ModalSubmit" type="button" class="waves-effect waves-white btn-flat" name="submit-button-thingy">Add Job-Task</button>
                        <button type="button" class="modal-close waves-effect waves-white btn-flat" data-dismiss="modal">Cancel</button>
                    </div>
                </div>
            </div>


        </div>

    </div>



    <input asp-for="ApprovalStatus" type="hidden" />
    @if (User.IsInRole(UserRoleName.Admin))
    {
        <input type="hidden" id="IsAdmin" value="true" />
    }
    <input asp-for="SelectedRowId" type="hidden" />
</form>

@section scripts {

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>


    <script type="text/javascript" src="/js/TimeEntry/weekTableSumDefinition.js"></script>
    <script type="text/javascript" src="/js/TimeEntry/weekTimeEntryTableSummation.js"></script>
    <script type="text/javascript" src="/js/TimeEntry/weekTimeEntryOvertimeToggle.js"></script>
    <script type="text/javascript" src="/js/TimeEntry/efforts/effort-repository.js"></script>
    <script type="text/javascript" src="/js/TimeEntry/modal-drop-down.js"></script>
    <script type="text/javascript" src="/js/TimeEntry/add-job-task-modal.js"></script>
    <script type="text/javascript" src="/js/TimeEntry/auto-cell-save.js"></script>
    <script type="text/javascript" src="/js/TimeEntry/auto-cell-save.js"></script>



    <script type="text/javascript" src="/js/TimeEntry/efforts/remove-effort-row.js"></script>
    <script type="text/javascript" src="/js/TimeEntry/efforts/add-effort-row.js"></script>
    <script type="text/javascript" src="/js/TimeEntry/efforts/change-effort-row.js"></script>
    <script type="text/javascript">

        const jobDataBlob = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.NewEntry.AvailableJobs.ToDictionary(x => x.FullJobCodeWithName, x => x.JobId))) ;






        function showSubmitModal(targetId) {
            let modalToShow = document.getElementById(targetId);
            let instance = M.Modal.init(modalToShow, {});
            instance.open();
        }

        function showCopyTasksModal(targetId) {
            let modalToShow = document.getElementById(targetId);
            let instance = M.Modal.init(modalToShow, {});
            instance.open();
        }

        function onCellFocus(cellTextInput) {
            cellTextInput.classList.remove("hide-the-text");
            cellTextInput.select();
        }
        function onCellUnFocus(cellTextInput) {
            if (cellTextInput.value == "0.0") {
                cellTextInput.classList.add("hide-the-text");
            }
        }
        $(document).ready(function () {

            const approvalStatus = $('#ApprovalStatus').val();
            const isAdmin = $('#IsAdmin').val() == "true";



            if ((approvalStatus == "Approved" || approvalStatus == "Submitted")) {
                $("form :input").not('.navbar-btn').prop("disabled", true);
                $('#AddJob').hide();
                $('a.row-action').hide();
                $('.hide-if-submitted').hide();
                if (isAdmin) {
                    $("form :input[type='submit']").prop("disabled", false);
                    $("form :input[name='__RequestVerificationToken']").prop("disabled", false);
                }
            };


            //enter key
            $('form').bind('keypress', function (e) {
                if (e.keyCode == 13) {
                    e.preventDefault();
                    $('#save-btn').click();
                }
            });

            $('#save-btn').click(e => {
                let form = $("#main-time-entry-form");
                let validator = form.validate();
                if (!form.valid()) {
                    $('div.week-errors').removeClass('validation-summary-valid');
                    $('div.week-errors').addClass('validation-summary-errors');
                    e.preventDefault();
                }
            });

            $('#copy-prev-week-tasks-trigger').click(e => {
                showSubmitModal('copyModal');
            })
            $('#submit-modal-trigger').click(e => {
                let form = $("#main-time-entry-form");
                let validator = form.validate();
                if (form.valid()) {
                    $('div.week-errors').removeClass('validation-summary-errors');
                    $('div.week-errors').addClass('validation-summary-valid');
                    showSubmitModal('submitModal');
                }
                else {
                    $('div.week-errors').removeClass('validation-summary-valid');
                    $('div.week-errors').addClass('validation-summary-errors');
                }
            });

        });</script>
}



